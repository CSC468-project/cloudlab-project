pipeline {
    agent {
		kubernetes {
			defaultContainer 'buildct'
			yamlFile 'kubesbuilder.yaml'
		}
	}

	node(buildct) {
	    stages {
			stage('Setup') {
				container('buildct') {
					sh 'pacman -Sy'
					sh 'pacman -S docker-compose --noconfirm'
				}
			}
	        stage('Build') {
				container('buildct') {
	                echo 'Building...'
					sh '(cd DockerFiles;docker-compose build)'
				}
			}
	        stage('Upload') {
				container('buildct') {
	                echo 'Uploading to Docker registry...'
					sh '(cd DockerFiles;docker-compose push)'
				}
			}
	        stage('Deploy') {
	            steps {
	                sh 'kubectl replace deployment pizzapie -f pizzapie.yaml'
        	    }
   		    }
	    }	
	}
}
